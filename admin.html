<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin – Hantera ansökningar | TerraTrade</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0e1a11;--bg2:#122218;--leaf:#50c878;--leaf2:#3ebd94;
      --line:#24432f;--text:#edf5ee;--muted:#b6c7b8;--card:#16271e
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1000px 700px at 80% -10%, rgba(47,191,113,.15), transparent 60%),
        linear-gradient(180deg,var(--bg),var(--bg2));
      min-height:100svh;
    }
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;border-bottom:1px solid rgba(255,255,255,.08)}
    a{color:var(--text);text-decoration:none}
    .container{max-width:1000px;margin:0 auto;padding:18px}
    .panel{border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01)) var(--card);border-radius:16px;padding:16px;margin-top:20px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,textarea{background:rgba(255,255,255,.03);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px}
    button{background:var(--leaf);border:none;color:#082013;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer}
    button:hover{background:var(--leaf2)}
    .ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
    .list{display:grid;gap:12px;margin-top:12px}
    .cardItem{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(255,255,255,.03)}
    .muted{color:var(--muted)}
    .err{background:rgba(255,106,106,.12);border:1px solid rgba(255,106,106,.5);color:#ffdede;padding:10px;border-radius:8px;margin-top:8px}
    .ok{background:rgba(80,200,120,.12);border:1px solid rgba(80,200,120,.5);color:#dff7e8;padding:10px;border-radius:8px;margin-top:8px}
  </style>
</head>
<body>
<header>
  <div class="row">
    <a href="index.html">← Start</a>
    <strong>Adminpanel</strong>
  </div>
  <div class="row">
    <span id="who" class="muted"></span>
    <button class="ghost" id="logoutBtn">Logga ut</button>
  </div>
</header>

<main class="container">
  <section class="panel">
    <h1>Hantera ansökningar</h1>
    <p class="muted">Endast admin. Godkänn eller avvisa inkomna företagsansökningar.</p>

    <!-- Loginfält om ej inloggad -->
    <div id="loginBox" class="row" style="margin-top:12px;display:none">
      <input id="email" type="email" placeholder="admin@mail.se" autocomplete="username"/>
      <input id="password" type="password" placeholder="Lösenord" autocomplete="current-password"/>
      <button id="loginBtn">Logga in</button>
    </div>

    <!-- Meddelanden -->
    <div id="alert"></div>

    <!-- Lista över pending ansökningar -->
    <div id="pendingWrap" style="margin-top:12px;display:none">
      <div class="row" style="justify-content:space-between">
        <h3>Inkomna ansökningar (pending)</h3>
        <button class="ghost" id="refreshBtn">Uppdatera</button>
      </div>
      <div id="pendingList" class="list"></div>
    </div>
  </section>
</main>

<script>
const supabase = window.supabase.createClient(
  "https://vkapxmpecvmrquockugi.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrYXB4bXBlY3ZtcnF1b2NrdWdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMjU3MjYsImV4cCI6MjA3NjcwMTcyNn0.VYTNc3gGQLe5KJIP2952I549h9n1SZiycSYQ9MXPdPs"
);

const whoEl = document.getElementById("who");
const alertEl = document.getElementById("alert");
const loginBox = document.getElementById("loginBox");
const pendingWrap = document.getElementById("pendingWrap");
const pendingList = document.getElementById("pendingList");

function setAlert(type, msg) {
  alertEl.className = type === "error" ? "err" : "ok";
  alertEl.textContent = msg;
}
function clearAlert() {
  alertEl.className = "";
  alertEl.textContent = "";
}

async function ensureAdmin() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    whoEl.textContent = "Inte inloggad";
    loginBox.style.display = "flex";
    pendingWrap.style.display = "none";
    currentAdmin = null;
    return null;
  }

  const { data: profile, error } = await supabase
    .from("profiles")
    .select("role, full_name")
    .eq("user_id", user.id)
    .single();

  if (error) {
    setAlert("error", "Kunde inte läsa profil: " + error.message);
    return null;
  }

  whoEl.textContent = `${profile.full_name || user.email} (${profile.role})`;

  if (profile.role !== "admin") {
    setAlert("error", "Du har inte admin-behörighet.");
    pendingWrap.style.display = "none";
    currentAdmin = null;
    return null;
  }

  loginBox.style.display = "none";
  currentAdmin = user;
  return user;
}

async function listPending() {
  clearAlert();
  const { data, error } = await supabase
    .from("applications")
    .select("*")
    .or("status.eq.pending,status.is.null")
    .order("created_at", { ascending: true });

  if (error) {
    setAlert("error", "Fel vid hämtning: " + error.message);
    return;
  }

  pendingList.innerHTML = "";
  if (!data || !data.length) {
    pendingList.innerHTML = `<div class="muted">Inga pending-ansökningar just nu.</div>`;
  } else {
    for (const a of data) {
      const el = document.createElement("div");
      el.className = "cardItem";
      el.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <strong>${a.company_name}</strong>
          <small class="muted">${new Date(a.created_at).toLocaleString()}</small>
        </div>
        <div class="muted">Org.nr: ${a.org_no}</div>
        <div>Kontakt: <strong>${a.contact_name}</strong> – <a href="mailto:${a.email}">${a.email}</a></div>
        ${a.message ? `<p style="margin-top:6px">${a.message}</p>` : ""}
        <div class="row" style="margin-top:10px">
          <button data-approve="${a.id}">Godkänn</button>
          <button class="ghost" data-reject="${a.id}">Avvisa</button>
        </div>`;
      pendingList.appendChild(el);
    }
  }
  pendingWrap.style.display = "block";
}

let currentAdmin = null;

async function resolveCompanyColumn(options) {
  for (const column of options) {
    const { error } = await supabase.from("companies").select(column).limit(1);
    if (!error) return column;
    if (!/column .* does not exist/i.test(error.message || "")) {
      throw error;
    }
  }
  return options[0];
}

async function approve(id) {
  clearAlert();
  const user = currentAdmin || await ensureAdmin();
  if (!user) return;

  const { data: application, error: appErr } = await supabase
    .from("applications")
    .select("*")
    .eq("id", id)
    .maybeSingle();

  if (appErr) {
    setAlert("error", "Kunde inte läsa ansökan: " + appErr.message);
    return;
  }
  if (!application) {
    setAlert("error", "Ansökan hittades inte.");
    return;
  }
  if (application.status && application.status !== "pending") {
    setAlert("error", "Ansökan är redan granskad (" + application.status + ").");
    listPending();
    return;
  }

  try {
    const companyNameColumn = await resolveCompanyColumn(["name", "company_name"]);
    const orgNoColumn = await resolveCompanyColumn([
      "org_no",
      "organisation_no",
      "organization_no",
      "organization_number"
    ]);

    const { data: nameClash, error: nameErr } = await supabase
      .from("companies")
      .select("id")
      .eq(companyNameColumn, application.company_name)
      .maybeSingle();
    if (nameErr) throw nameErr;
    if (nameClash) {
      setAlert("error", "Ett företag med samma namn finns redan.");
      return;
    }

    const { data: orgClash, error: orgErr } = await supabase
      .from("companies")
      .select("id")
      .eq(orgNoColumn, application.org_no)
      .maybeSingle();
    if (orgErr) throw orgErr;
    if (orgClash) {
      setAlert("error", "Organisationsnumret används redan.");
      return;
    }

    const { data: newCompany, error: createErr } = await supabase
      .from("companies")
      .insert({
        [companyNameColumn]: application.company_name,
        [orgNoColumn]: application.org_no
      })
      .select("id")
      .single();

    if (createErr) throw createErr;

    const companyId = newCompany.id;

    const profilePayload = {
      user_id: application.applicant_user_id,
      role: "company_admin",
      company_id: companyId
    };
    if (application.contact_name) {
      profilePayload.full_name = application.contact_name;
    }

    const { error: profileErr } = await supabase
      .from("profiles")
      .upsert(profilePayload, { onConflict: "user_id" });
    if (profileErr) throw profileErr;

    const applicationUpdate = { status: "approved" };
    if ("company_id" in application) applicationUpdate.company_id = companyId;
    if ("approved_company_id" in application) applicationUpdate.approved_company_id = companyId;
    if ("reviewed_at" in application) applicationUpdate.reviewed_at = new Date().toISOString();
    if ("reviewed_on" in application) applicationUpdate.reviewed_on = new Date().toISOString();
    if ("reviewed_by" in application) applicationUpdate.reviewed_by = user.id;
    if ("reviewed_by_user_id" in application) applicationUpdate.reviewed_by_user_id = user.id;
    if ("reviewer_user_id" in application) applicationUpdate.reviewer_user_id = user.id;
    if ("rejection_reason" in application) applicationUpdate.rejection_reason = null;
    if ("review_comment" in application) applicationUpdate.review_comment = null;

    const { error: updateErr } = await supabase
      .from("applications")
      .update(applicationUpdate)
      .eq("id", id);
    if (updateErr) throw updateErr;

    setAlert("ok", "Ansökan godkänd ✅");
    listPending();
  } catch (err) {
    console.error(err);
    setAlert("error", err.message || "Godkännande misslyckades.");
  }
}

async function reject(id) {
  const reason = prompt("Kommentar (valfri):") || null;
  clearAlert();
  const user = currentAdmin || await ensureAdmin();
  if (!user) return;

  const { data: application, error: appErr } = await supabase
    .from("applications")
    .select("*")
    .eq("id", id)
    .maybeSingle();

  if (appErr) {
    setAlert("error", "Kunde inte läsa ansökan: " + appErr.message);
    return;
  }
  if (!application) {
    setAlert("error", "Ansökan hittades inte.");
    return;
  }

  const applicationUpdate = {
    status: "rejected"
  };
  if ("rejection_reason" in application) applicationUpdate.rejection_reason = reason;
  if ("review_comment" in application) applicationUpdate.review_comment = reason;
  if ("reviewed_at" in application) applicationUpdate.reviewed_at = new Date().toISOString();
  if ("reviewed_on" in application) applicationUpdate.reviewed_on = new Date().toISOString();
  if ("reviewed_by" in application) applicationUpdate.reviewed_by = user.id;
  if ("reviewed_by_user_id" in application) applicationUpdate.reviewed_by_user_id = user.id;
  if ("reviewer_user_id" in application) applicationUpdate.reviewer_user_id = user.id;

  const { error } = await supabase
    .from("applications")
    .update(applicationUpdate)
    .eq("id", id);

  if (error) {
    setAlert("error", error.message);
    return;
  }
  setAlert("ok", "Ansökan avvisad ❌");
  listPending();
}

// === Event-lyssnare ===
document.getElementById("loginBtn").onclick = async () => {
  clearAlert();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) {
    setAlert("error", error.message);
    return;
  }
  setAlert("ok", "Inloggad.");
  const user = await ensureAdmin();
  if (user) listPending();
};

document.getElementById("logoutBtn").onclick = async () => {
  await supabase.auth.signOut();
  location.href = "login.html";
};

document.getElementById("refreshBtn").onclick = listPending;

pendingList.addEventListener("click", (e) => {
  const t = e.target;
  if (t.dataset.approve) approve(t.dataset.approve);
  if (t.dataset.reject) reject(t.dataset.reject);
});

// === Initiering ===
(async () => {
  const user = await ensureAdmin();
  if (user) await listPending();
  supabase.auth.onAuthStateChange(async () => {
    const u = await ensureAdmin();
    if (u) listPending();
  });
})();
</script>
</body>
</html>
